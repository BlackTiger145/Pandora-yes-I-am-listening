// ==UserScript==
// @name        Pandora I am listening
// @namespace   Pandora I am listening
// @description click
// @include     https://www.pandora.com/*
// @version     7/1/18
// @Author      Itai
// @grant GM_registerMenuCommand
// ==/UserScript==

//buttons and functions
function next() {
    document.querySelectorAll('[data-qa=skip_button]') [0].click();
}
function listening() {
    document.querySelectorAll('[data-qa=keep_listening_button]') [0].click();
}
function play() {
    document.querySelectorAll('[data-qa=play_button]') [0].click();
}
function reload() {
    location.reload();
}
function getTime() {
    var time = document.querySelectorAll('[data-qa=elapsed_time]') [0].innerHTML.replace(':', '');
    return time;
}
function getName(){
    var name =document.getElementsByClassName('Marquee Marquee--stopOnHover') [0].childNodes[0].innerHTML + ' - ' +
        document.getElementsByClassName('NowPlayingTopInfo__current__artistName NowPlayingTopInfo__current__artistName--link') [0].innerHTML;
    name = name.replace('amp;', '');
    return name;
}
function restricted(){
    var restricted = document.getElementsByClassName('Restricted__title')[0];
    if (restricted !=null){
        reload();
    }
}
function skipOnStop() {
    var playButton = document.querySelectorAll('[data-qa=play_button]') [0];
    if (playButton != null) {
        play();
    }
    var time = getTime();
    setTimeout(function () {
        var timeNow = getTime();
        //alert(time + ' now -' + timeNow);
        if (time == timeNow) {
            next();
        }
        reloadNoProg(time);
    }, 10000);
}
function reloadNoProg(n) {
    var time = n;
    setTimeout(function () {
        var timeNow = getTime();
        //alert(time + ' now reload -' + timeNow);
        if ((time == timeNow) || (timeNow == null)) {
            reload();
        }
        else {
            skipOnStop();
        }
    }, 30000);
}
function listeningCheck() {
    var lisButton = document.querySelectorAll('[data-qa=keep_listening_button]') [0];
    if (lisButton != null) {
        listening();
    }
    setTimeout(listeningCheck, 5000);
}
function indicator(){
    var one = document.getElementsByClassName('ButtonLink ButtonLink--nav ButtonLink--nav--upgrade--darkTheme') [0];
    one.innerHTML= "Custom Script";
    indicatorColor(one);
}
function indicatorColor(one){
    one.style.color="black";
    setTimeout(function(){
        one.style.color="#e66767";
    },3000);
}
function title(){
    var title = getName();
    document.title= title;
}
function shuffle(){
    //alert("in shufle");
    var shuffleCheck = document.getElementsByClassName('ShuffleButton__button__shuffleString') [0].innerHTML;
    var n = shuffleCheck.includes('Shuffle Stations On');
    //alert('test'+ n);
    if(n == false ){
        //alert('in the if');
        document.getElementsByClassName('ShuffleButton__button--compact--minimal')[0].click();
        setTimeout (shuffle,2000);
    }
}

//The script action order
window.onload = setTimeout(start,8000);

function start(){
    var title = document.title;
    //check if in the log-in screen
    var titleLogIn = title.includes('Music and Podcasts');
    var titlePlayer = title.includes ('Now Playing');
    if (titleLogIn == true){
        document.getElementsByClassName('ButtonT3 ButtonT3--large ButtonT3--dark ButtonT3--full')[0].click();
        setTimeout(start,3000);
    }
    //check if in the player menu
    else if ( titlePlayer == false){
        //alert('player');
        start();
    }
    //move to start setting the player scripts
    else {
        inPlayer();
    }
}

function inPlayer(){
    setTimeout(function(){
        listeningCheck();
        skipOnStop();
        shuffle();
    },5000);
    setInterval(function(){
        restricted();
        title();
        indicator();
    },5000);

}
